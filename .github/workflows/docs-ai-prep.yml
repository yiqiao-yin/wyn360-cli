name: Build AI Documentation Index

on:
  push:
    branches: [ main ]
    paths:
      - 'docs/**'
      - 'scripts/build_search_index.py'
      - '.github/workflows/docs-ai-prep.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'docs/**'
      - 'scripts/build_search_index.py'

# Allow manual triggering for testing
  workflow_dispatch:

jobs:
  build-ai-index:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: latest
        virtualenvs-create: true
        virtualenvs-in-project: true

    - name: Cache Poetry dependencies
      uses: actions/cache@v4
      with:
        path: .venv
        key: venv-${{ runner.os }}-${{ hashFiles('**/poetry.lock') }}

    - name: Install dependencies
      run: |
        poetry install --with dev

    - name: Install AI preprocessing dependencies
      run: |
        poetry add sentence-transformers torch numpy scikit-learn

    - name: Create scripts directory
      run: |
        mkdir -p scripts

    - name: Build AI search index with embeddings
      run: |
        # Build the search index to docs directory so MkDocs includes it
        mkdir -p docs/assets
        poetry run python scripts/build_search_index.py --output-dir docs/assets --verbose

    - name: Verify search index
      run: |
        if [ -f "docs/assets/search-index.json" ]; then
          echo "âœ… Search index generated successfully"
          echo "ðŸ“Š Index size: $(wc -c < docs/assets/search-index.json) bytes"
          echo "ðŸ“ Chunks: $(poetry run python -c "import json; data=json.load(open('docs/assets/search-index.json')); print(data['metadata']['total_chunks'])")"
        else
          echo "âŒ Search index not found"
          exit 1
        fi

    - name: Build documentation with AI index
      run: |
        # MkDocs will automatically include files from docs/assets/
        poetry run mkdocs build

        # Verify the index was included in the built site
        if [ -f "site/assets/search-index.json" ]; then
          echo "âœ… AI search index deployed to site"
          echo "ðŸ“Š Index size: $(wc -c < site/assets/search-index.json) bytes"
        else
          echo "âŒ AI search index missing from site build"
          ls -la site/assets/ || echo "No site/assets directory"
          exit 1
        fi

    - name: Verify deployment assets
      run: |
        echo "ðŸ” Verifying deployment assets..."
        ls -la site/assets/ || echo "No assets directory"
        ls -la site/css/ || echo "No CSS directory"
        ls -la site/js/ || echo "No JS directory"
        if [ -f "site/assets/search-index.json" ]; then
          echo "âœ… Search index ready for deployment: $(wc -c < site/assets/search-index.json) bytes"
        else
          echo "âŒ Search index missing from deployment"
        fi

    - name: Deploy to GitHub Pages (main branch only)
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./site

    - name: Upload search index as artifact (for PRs and testing)
      if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'
      uses: actions/upload-artifact@v4
      with:
        name: ai-search-index
        path: |
          docs/assets/search-index.json
          docs/assets/embedding-model-info.json
        retention-days: 7

    - name: Comment on PR with index stats
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const indexPath = 'docs/assets/search-index.json';

          if (fs.existsSync(indexPath)) {
            const indexData = JSON.parse(fs.readFileSync(indexPath, 'utf8'));
            const sizeKB = Math.round(fs.statSync(indexPath).size / 1024);

            const comment = `## ðŸ¤– AI Search Index Generated

            **ðŸ“Š Index Statistics:**
            - **Chunks:** ${indexData.chunks?.length || 0}
            - **Size:** ${sizeKB}KB
            - **Model:** ${indexData.metadata?.embedding_model || 'sentence-transformers/all-MiniLM-L6-v2'}
            - **Build Date:** ${indexData.metadata?.build_date || 'Unknown'}

            **âœ… Status:** AI search index built successfully and ready for deployment.

            **ðŸ” Test Coverage:** The index includes content from:
            ${indexData.metadata?.sections?.map(s => `- ${s}`).join('\n') || '- All documentation sections'}
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          }